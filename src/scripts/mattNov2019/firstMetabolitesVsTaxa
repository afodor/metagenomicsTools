
rm(list=ls())

setwd("C:\\MattNov14");
library("Kendall")

myT <- read.delim("genuswMetadata.tsv", header=TRUE, comment.char="@", stringsAsFactors=FALSE,check.name=FALSE)
myT <- myT[!is.na(myT[,2]),]

taxaRange <- 2:which(names(myT)=="SampleSum")

metaboliteLow <- which(names(myT)=="Liver DHMA (ug/G)")
metaboliteHigh <- ncol(myT)
metaboliteRange <- c(  which(names(myT)=="Corticosterone Values (pg/ml)"), metaboliteLow:metaboliteHigh )

pValues <- vector()
taxaName <- vector()
metaboliteName <- vector()
spearmanR <- vector()
sampleSize <- vector()

index <-1 
for( i in taxaRange )
{
	if( sum(myT[,i] ==0 ) <= nrow(myT) /4 ) 
	{
		for( j in metaboliteRange )
		{
			allTaxa <- as.numeric(myT[,j])
		
			toInclude<- !is.na(allTaxa)
			
			taxaData <- myT[toInclude,i]
			metaboliteData <- allTaxa[toInclude]
			pValues[index] <- Kendall(taxaData ,metaboliteData )$sl
			taxaName[index] <- names(myT)[i]
			metaboliteName[index] <- names(myT)[j]
			spearmanR[index] <- cor(taxaData ,metaboliteData ,method="spearman")
			sampleSize[index] <- length(taxaData )
			index <- index + 1
		}		
	}
}

hist(pValues)

myFrame <- data.frame(pValues,taxaName ,metaboliteName ,spearmanR ,sampleSize )
myFrame$adjutedP <- p.adjust(myFrame$pValues, method="BH")

write.table(myFrame, file=paste("firstPValuesGenus.txt",sep=""), sep="\t",row.names=FALSE)
