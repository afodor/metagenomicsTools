
rm(list=ls())

setwd("C:\\ChristinePierce_Dec2019")

levels <- c( "phylum", "class" , "order", "family", "genus", "OTU" )

for( taxa in levels ) 
{	
	inFileName <- paste0("pcoa_metadata", taxa, ".txt")	
	myT <- read.table(inFileName, header=TRUE,sep="\t")
	myT <- myT[ !is.na(myT$PatientNo), ]
	patientIDs <- factor( myT$PatientNo)
	status <- factor( myT$Status) 
	treatmentType <-  myT$TreatmentType
	
	analysisCols <- c(2,14:which(names(myT)=="MDS5"))
	
	pValueStatus <- vector()
	pValueIndividual <- vector()
	pValueTreatmentType <- vector()
	taxaName <- vector()
	
	index  <- 1
	for( i in analysisCols )
	{
		data <- myT[,i]
		
		if( sum(data !=0) > (length(data) / 4 ) ) 
		{	
			aLm <- lm( data ~  status + treatmentType +  patientIDs )
			anAnova <- anova(aLm)
			pValueStatus[index] <- anAnova$"Pr(>F)"[1]
			pValueTreatmentType[index] <- anAnova$"Pr(>F)"[2]
			pValueIndividual[index] <- anAnova$"Pr(>F)"[3]
			taxaName[index] <- names(myT)[i]
			index = index +1
		}		
	}
	
	dFrame <- data.frame(taxaName,pValueStatus,pValueTreatmentType,pValueIndividual)
	dFrame <- dFrame [order(dFrame$pValueStatus),]
	dFrame$pValuesStatusAdjusted<- p.adjust( dFrame$pValueStatus, method = "BH")
	dFrame$pValuesSubjectAdjusted<- p.adjust( dFrame$pValueIndividual, method = "BH")
	dFrame$pValuesTreatmentTypeAdjusted<- p.adjust( dFrame$pValueTreatmentType, method = "BH")
	
	write.table(dFrame, file=paste("taxa_models_", taxa,".txt",sep=""), sep="\t",row.names=FALSE)
}